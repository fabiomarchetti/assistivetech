# ğŸ“‹ RIASSUNTO SESSIONE LAVORO - 31 Ottobre 2025

## ğŸ¯ PROGETTO: "Agenda" in JavaScript Vanilla (PWA)

### OBIETTIVO PRINCIPALE
Sviluppare un'applicazione PWA per gestire sequenze di attivitÃ  con pittogrammi ARASAAC, basata su `agenda_timer` (Flutter) ma in **JavaScript vanilla**.

Caratteristiche chiave:
- âœ… Multi-agende per utente
- âœ… Navigazione agende collegate (swipe + long-click)
- âœ… Supporto offline (SQLite locale)
- âœ… Educatore + Paziente (due interfacce separate)

---

## ğŸ“Š STATO ATTUALE DEL PROGETTO

### âœ… COMPLETATO (10/10 file core)

| File | Stato | Descrizione |
|------|-------|------------|
| `db-manager.js` | âœ… | SQLite locale (sql.js), CRUD agende/items, transazioni |
| `api-client.js` | âœ… | REST client per backend PHP (agende.php, items.php) |
| `swipe-handler.js` | âœ… | Swipe/long-click, touch+mouse+keyboard, feedback tattile |
| `arasaac-service.js` | âœ… | Ricerca pittogrammi ARASAAC con cache e debounce (350ms) |
| `youtube-service.js` | âœ… | Ricerca video YouTube, embed URL, thumbnail |
| `agenda-app.js` | âœ… | Navigazione paziente (swipe attivitÃ , long-click sub-agende) |
| `educatore-app.js` | âœ… | Gestione agende/item, modali, drag&drop |
| `service-worker.js` | âœ… | Offline support, caching, background sync, push |
| `agenda.html` | âœ… | Layout paziente con swipe |
| **API PHP** | âœ… | `agende.php` e `items.php` (CRUD completo) |

### âš ï¸ DA VERIFICARE/COMPLETARE

1. **gestione.html** - Interfaccia educatore (verificare modali, form)
2. **css/agenda.css** - Stili paziente fullscreen (responsive)
3. **css/educatore.css** - Stili educatore (modal, card, grid)
4. **manifest.json** - Configurazione PWA (icone, theme)
5. **assets/** - Icone, favicon, immagini

---

## ğŸ—„ï¸ STRUTTURA DATABASE

**Database**: `assistivetech_local` (MySQL, MAMP localhost)

### Tabella `agende_strumenti` (8 colonne)
```sql
id_agenda (PK, AUTO_INCREMENT)
nome_agenda (VARCHAR 200) - Nome agenda
id_paziente (FK) - Paziente proprietario
id_educatore (FK) - Educatore creatore
id_agenda_parent (Nullable, FK) - Per agende collegate (NULL=principale)
tipo_agenda (ENUM: 'principale', 'sottomenu')
data_creazione (VARCHAR 19)
stato (ENUM: 'attiva', 'archiviata')
```

### Tabella `agende_items` (14 colonne)
```sql
id_item (PK, AUTO_INCREMENT)
id_agenda (FK) - Agenda padre
tipo_item (ENUM: 'semplice', 'link_agenda', 'video_youtube')
titolo (VARCHAR 255)
posizione (INT) - Per drag&drop riordinamento
tipo_immagine (ENUM: 'arasaac', 'upload', 'nessuna')
id_arasaac (INT, Nullable) - ID pittogramma ARASAAC
url_immagine (VARCHAR 500) - Path immagine upload
id_agenda_collegata (INT, Nullable, FK) - Apre altra agenda con long-click
video_youtube_id (VARCHAR 50)
video_youtube_title, video_youtube_thumbnail
data_creazione, stato
```

---

## ğŸ”‘ FUNZIONALITÃ€ IMPLEMENTATE

### INTERFACCIA PAZIENTE (agenda.html)
- **Swipe orizzontale**: Passa da un'attivitÃ  alla successiva
- **Long-click (800ms)**: Apre agenda collegata (se tipo_item='link_agenda')
- **Stack navigazione**: Bottone "Indietro" per tornare all'agenda precedente
- **Supporto contenuti**: ARASAAC pittogrammi, foto upload, video YouTube
- **Offline mode**: SQLite locale per funzionamento senza internet

**Flow utente**:
```
Seleziona utente
    â†“
Carica agenda principale
    â†“
Mostra primo item con immagine
    â†“
Swipe â†’ attivitÃ  successiva
    â†“
Long-click su item link_agenda â†’ apre agenda collegata
```

### INTERFACCIA EDUCATORE (gestione.html)
- **Selezione paziente**: Dropdown dinamico (tutti pazienti per admin/dev, solo assegnati per educatore)
- **Creazione agende**: Principale + sottomenu con parent-child relationship
- **Gestione item**: 3 tipi (semplice, link_agenda, video_youtube)
- **Drag & drop**: Riordina item con SortableJS
- **Ricerca ARASAAC**: Integrata con API ARASAAC (debounce 350ms)
- **Ricerca YouTube**: Integrata con YouTube Data API v3
- **Upload immagini**: Supporta JPG, PNG, GIF, WebP (max 5MB)

### AUTENTICAZIONE & PERMESSI
- **Utente "Anonimo"**: Disponibile per sviluppatori (localhost)
  - Usa localStorage (`agende_anonimo`, `items_anonimo_*`)
  - Non sincronizza con server (solo per test)
  - Auto-selezionato in ambiente locale
- **Educatori reali**: Vede solo pazienti assegnati (verificato da API)
- **Auto-detect**: Script rileva localhost vs produzione automaticamente

---

## ğŸ“ STRUTTURA CARTELLE

```
/training_cognitivo/strumenti/agenda/
â”œâ”€â”€ index.html               # Landing (educatore/paziente)
â”œâ”€â”€ agenda.html              # âœ… Interfaccia paziente
â”œâ”€â”€ gestione.html            # âš ï¸ Interfaccia educatore
â”œâ”€â”€ manifest.json            # âš ï¸ PWA config
â”œâ”€â”€ service-worker.js        # âœ… SW offline/sync
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ agende.php          # âœ… CRUD agende (create, list, get, update, delete)
â”‚   â”œâ”€â”€ items.php           # âœ… CRUD items (create, list, get, update, reorder, delete)
â”‚   â””â”€â”€ upload_image.php    # Upload immagini
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ agenda.css          # âš ï¸ Stili paziente
â”‚   â””â”€â”€ educatore.css       # âš ï¸ Stili educatore
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ db-manager.js       # âœ… SQLite locale
â”‚   â”œâ”€â”€ api-client.js       # âœ… REST client
â”‚   â”œâ”€â”€ swipe-handler.js    # âœ… Gesture handling
â”‚   â”œâ”€â”€ arasaac-service.js  # âœ… ARASAAC API
â”‚   â”œâ”€â”€ youtube-service.js  # âœ… YouTube API
â”‚   â”œâ”€â”€ agenda-app.js       # âœ… Logica paziente
â”‚   â””â”€â”€ educatore-app.js    # âœ… Logica educatore
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ icons/              # âš ï¸ Icone PWA
â””â”€â”€ HIKU_31_10_2025.md      # Questo file (punto ripartenza)
```

---

## ğŸ”Œ API ENDPOINTS DISPONIBILI

### agende.php
- `POST /api/agende.php?action=create` - Crea agenda
- `GET /api/agende.php?action=list&id_paziente=X` - Lista agende
- `GET /api/agende.php?action=get&id_agenda=X` - Dettagli agenda
- `PUT /api/agende.php?action=update&id_agenda=X` - Aggiorna nome
- `DELETE /api/agende.php?action=delete&id_agenda=X` - Soft delete

### items.php
- `POST /api/items.php?action=create` - Crea item
- `GET /api/items.php?action=list&id_agenda=X` - Lista item
- `GET /api/items.php?action=get&id_item=X` - Dettagli item
- `PUT /api/items.php?action=update&id_item=X` - Aggiorna item
- `PUT /api/items.php?action=reorder` - Riordina items (batch)
- `DELETE /api/items.php?action=delete&id_item=X` - Soft delete

---

## âš™ï¸ CONFIGURAZIONI IMPORTANTI

### YouTube API Key
- **Attuale**: `AIzaSyAKrM5EtCxmo_7_kSSN1rpalvb9QfDIan8`
- **Ubicazione**: `js/youtube-service.js` linea 16
- **âš ï¸ CONSIGLIO**: Generare nuova key da [Google Cloud Console](https://console.cloud.google.com/)

### Base Path Detection
```javascript
const BASE_PATH = window.location.pathname.includes('/Assistivetech/')
    ? '/Assistivetech'
    : '';
```
Auto-detect per localhost (MAMP) vs produzione (Aruba)

### Service Worker Cache
- **Cache name**: `agenda-strumenti-v1`
- **Strategia**:
  - Network First per API (fallback cache)
  - Cache First per asset statici

---

## ğŸ§ª TESTING LOCALE

### Accesso Interfacce
- **Paziente**: `http://localhost:8888/Assistivetech/training_cognitivo/strumenti/agenda/agenda.html`
- **Educatore**: `http://localhost:8888/Assistivetech/training_cognitivo/strumenti/agenda/gestione.html`

### Test ModalitÃ  Anonimo
1. Apri `gestione.html`
2. Auto-seleziona "ğŸ‘¤ Anonimo (Test)"
3. Crea agenda + item
4. Dati salvati in localStorage (`agende_anonimo`)
5. Apri `agenda.html` â†’ Seleziona "Utente Test" â†’ Vedi stessa agenda

### Swipe & Long-click
- **Desktop**: Mouse drag o arrow keys
- **Mobile**: Gesture touch reali

---

## ğŸ¤ TTS (TEXT-TO-SPEECH) - IMPLEMENTATO

### âœ… Campo "Frase TTS" (fraseVocale)
- **Ubicazione**: Form modal "Aggiungi Item" in `gestione.html`
- **Tipo**: Textarea per frasi piÃ¹ lunghe
- **Validazione**: Campo obbligatorio (come titolo)
- **Salvataggio**: Campo `fraseVocale` nei dati item

### âœ… TTS AUTOMATICO all'arrivo dell'item
- **Quando**: Caricamento di un item (swipe, cambio pagina, long-click)
- **Comportamento**:
  - Ferma TTS precedente automaticamente
  - Pronuncia frase con delay 300ms (assicura rendering DOM)
  - Usa impostazioni slider (velocitÃ  + volume)
- **Logica**: In `displayItem()` â†’ chiama `playTTS()`

### âœ… Bottone "Ascolta" per ripetizione manuale
- **Ubicazione**: Nel render dell'item (sotto il titolo)
- **Icon**: ğŸ”Š Volume-up
- **Funzione**: Consente ripetizione della frase on-demand
- **Usa slider**: Rispetta impostazioni correnti

### âœ… Due Slider Controlli TTS
**Ubicazione**: In basso sullo schermo, sopra il container fullscreen

**VelocitÃ  (rate)**:
- Range: 0.5x - 2.0x
- Default: 0.9x (leggibile)
- Step: 0.1
- Salva in localStorage: `tts_velocity`

**Volume**:
- Range: 30% - 100%
- Default: 100%
- Step: 10%
- Salva in localStorage: `tts_volume`

**Stile CSS**:
- Posizionamento: Fixed bottom-20px
- Sfondo: Bianco semi-trasparente con blur
- Slider thumb: Viola, scale on hover
- Responsive: Gap fra controlli adattabile

### âœ… Nuovo file: `tts-service.js`
- **Funzioni**:
  - `speak(testo, options)` - Pronuncia testo con opzioni
  - `stop()` - Ferma pronuncia
  - `pause()` - Pausa (se browser supporta)
  - `resume()` - Riprendi (se browser supporta)
  - `isSupported()` - Verifica supporto browser
- **Lingua**: Italiano IT-IT di default
- **Web Speech API nativa**: Non richiede dipendenze esterne

### âœ… Immagini ridimensionate (card educatore)
- **Prima**: `object-fit: cover` (tagliava immagini piccole)
- **Adesso**: `object-fit: contain` (mantiene proporzioni)
- **Padding**: 10px interno (spazio per pittogrammi)
- **Background**: Grigio chiaro (#f8f9fa)

---

## ğŸ”§ MODIFICHE DETTAGLIATE - SESSIONE 2 (31-10-2025 Sera)

### ğŸ“ gestione.html
```html
<!-- Nuovo campo Frase TTS -->
<textarea id="inputFraseTTS" class="form-control"
          placeholder="es: Voglio mangiare un gelato" rows="2"></textarea>
```

### ğŸ¨ agenda.html
```html
<!-- Nuovi slider TTS -->
<div class="tts-controls">
  <div class="tts-control-group">
    <label for="sliderVelocity">VelocitÃ :</label>
    <input type="range" id="sliderVelocity" min="0.5" max="2" step="0.1" value="0.9">
    <span id="velocityValue">0.9x</span>
  </div>
  <div class="tts-control-group">
    <label for="sliderVolume">Volume:</label>
    <input type="range" id="sliderVolume" min="0.3" max="1" step="0.1" value="1">
    <span id="volumeValue">100%</span>
  </div>
</div>
```

### ğŸ–¼ï¸ css/agenda.css (Aggiunto)
```css
.tts-controls { /* Slider container bottom */ }
.tts-control-group { /* Flex row per label + slider */ }
.tts-slider { /* Input range styling */ }
.tts-slider::-webkit-slider-thumb { /* Thumb viola */ }
```

### ğŸ–¼ï¸ css/educatore.css (Modificato)
```css
.item-card .card-img-top {
    object-fit: contain;  /* â† Da cover a contain */
    padding: 10px;        /* â† Aggiunto */
}
```

### ğŸ“œ js/educatore-app.js (Modificato)
- `loadPazienti()`: Migliorata gestione errori API con fallback anonimo
- `selectAgenda()`: Supporta localStorage per anonimo
- `createItem()`: Aggiunto salvataggio `fraseVocale`
- `openAddItemModal()`: Reset del campo TTS
- `deleteItem()`: Supporta localStorage
- `deleteAgenda()`: Supporta localStorage
- `handleReorder()`: Supporta localStorage

### ğŸ“œ js/agenda-app.js (Modificato)
```javascript
// Nuovo: inizializzazione slider
initTTSSliders()

// Nuova funzione
getTTSSettings() // Ritorna { velocity, volume }

// Modificato displayItem()
// Adesso ferma TTS precedente e pronuncia automatico

// Modificato renderStandardItem() e renderVideoItem()
// Aggiunto bottone "Ascolta" se fraseVocale disponibile

// Modificato playTTS()
// Usa slider settings invece di valori hardcoded
```

### ğŸ†• js/tts-service.js (NUOVO FILE)
```javascript
// Web Speech API wrapper
TTSService.speak(testo, options)
TTSService.stop()
TTSService.isSupported()
```

---

## ğŸ“‹ TODO PROSSIMA SESSIONE

### âœ… COMPLETATO OGGI SERA
- [x] Campo TTS "Frase da Pronunciare" nel form
- [x] TTS automatico all'arrivo dell'item
- [x] Bottone "Ascolta" per ripetere manualmente
- [x] Due slider: VelocitÃ  + Volume
- [x] Persistenza slider in localStorage
- [x] Immagini ridimensionate card educatore
- [x] Risolto errore "Errore caricamento pazienti"
- [x] Supporto localStorage per anonimo (selectAgenda, createItem, deleteItem, etc.)

### Immediato (prossima sessione)
- [ ] Testing completo TTS automatico
- [ ] Verificare slider velocitÃ /volume funcionano
- [ ] Test su mobile (gesti reali, TTS pronuncia)
- [ ] Verificare localStorage salva impostazioni tra sessioni

### Medio (prioritÃ  alta)
- [ ] Completare CSS responsive mobile-first
- [ ] Verificare manifest.json PWA
- [ ] Testing completo swipe/long-click con TTS
- [ ] Testing drag&drop educatore
- [ ] Test apertura sub-agende (long-click)

### Basso (nice-to-have)
- [ ] Aggiungere Timer automatico avanzamento
- [ ] Aggiungere Analytics/Logging
- [ ] Deploy produzione (Aruba)
- [ ] Icone custom PWA in assets/

---

## ğŸ” PROBLEMI RISOLTI

### âœ… ERRORE CARICAMENTO PAZIENTI
- **Status**: ğŸŸ¢ **RISOLTO**
- **Soluzione**: Aggiunto fallback a "Anonimo (Test - Dev)" quando API fallisce
- **Ubicazione**: `loadPazienti()` in educatore-app.js
- **Comportamento**: Sviluppatore continua normalmente con modalitÃ  anonimo

---

## ğŸ’¡ NOTE IMPORTANTI

1. **Cross-Platform**: L'app funziona su web, mobile (iOS/Android), desktop
2. **PWA Installabile**: Supporta aggiunta a home screen (mobile) e installazione (desktop)
3. **Offline First**: Tutti i dati sono in cache locale, sincronizza quando online
4. **Soft Delete**: Eliminazioni logiche (flaggano come `stato='archiviato'`)
5. **Sviluppatore vs Reale**: Utente anonimo per test, utenti reali da database

---

## ğŸ“ CONTATTI DOCUMENTAZIONE

- **Flutter Original**: `/agenda_timer/` (usata come riferimento)
- **Database**: `assistivetech_local` (MySQL su MAMP)
- **API Esterne**:
  - ARASAAC: https://api.arasaac.org/developers.html
  - YouTube: https://developers.google.com/youtube/v3

---

**Data**: 31 Ottobre 2025
**Versione**: 1.0.0 (Analisi Completa)
**Status**: âœ… Struttura Core Completa, âš ï¸ Da verificare/testare, ğŸ”´ Errore caricamento pazienti

---
