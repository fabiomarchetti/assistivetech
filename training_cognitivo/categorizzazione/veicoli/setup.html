<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup - Categorizzazione Veicoli</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style> body { background: #f5f7fb; } .setup-card{max-width:560px;margin:6vh auto;} </style>
</head>
<body>
  <div class="card shadow setup-card">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Setup â€“ Categorizzazione di Veicoli</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Educatore</label>
        <input id="educatorName" type="text" class="form-control" placeholder="Nome educatore" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Paziente/Utente</label>
        <select id="patientSelect" class="form-select" required>
          <option value="" selected>Seleziona paziente...</option>
        </select>
      </div>
      <div class="row g-3">
        <div class="col-6">
          <label class="form-label">Numero item</label>
          <select id="numItems" class="form-select">
            <option value="2">2</option>
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="8">8</option>
            <option value="10">10</option>
            <option value="12" selected>12</option>
            <option value="16">16</option>
            <option value="20">20</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">Feedback vocale</label>
          <select id="ttsFeedback" class="form-select">
            <option value="on" selected>Attivo</option>
            <option value="off">Disattivo</option>
          </select>
        </div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button id="startBtn" class="btn btn-success w-100"><i class="bi bi-play-fill me-1"></i>Inizia</button>
        <a href="../" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i></a>
      </div>
    </div>
  </div>

  <script>
    // AUTO-DETECTION BASE_PATH (locale MAMP vs produzione Aruba)
    const BASE_PATH = window.location.pathname.includes('/Assistivetech/') ? '/Assistivetech' : '';
    const API_BASE = `${BASE_PATH}/api`;
    function getLoggedUser(){ try{return JSON.parse(localStorage.getItem('user')||'null')}catch{ return null; }}
    async function fetchPatients(){ try{ const r=await fetch(`${API_BASE}/api_pazienti.php?action=get_all`); const j=await r.json(); return j.success?j.data:[];}catch{return []}}
    async function init(){
      const user=getLoggedUser();
      const educator=document.getElementById('educatorName');
      const patient=document.getElementById('patientSelect');
      let fullName='Sviluppatore';
      let role=(user&&(user.ruolo_registrazione||user.role))?(user.ruolo_registrazione||user.role):'sviluppatore';
      role=String(role).toLowerCase();
      if(user&&user.nome_registrazione&&user.cognome_registrazione){ fullName=`${user.nome_registrazione} ${user.cognome_registrazione}`.trim(); }
      if(role.includes('sviluppatore')||role.includes('developer')||role.includes('admin')||role.includes('amministratore')){
        educator.value=fullName||'Sviluppatore'; patient.innerHTML='<option value="Anonimo" selected>Anonimo</option>'; return;
      }
      educator.value=fullName||'';
      const all=await fetchPatients();
      const mine=all.filter(p=> (p.educatore_assegnato||'').toLowerCase()===fullName.toLowerCase() && String(p.is_attiva)==='1');
      if(!mine.length){ patient.innerHTML='<option value="Anonimo" selected>Anonimo</option>'; }
      else{ patient.innerHTML='<option value="" selected>Seleziona paziente...</option>'+mine.map(p=>{const n=(p.nome||p.nome_paziente||'').trim(); const c=(p.cognome||p.cognome_paziente||'').trim(); const f=(n+' '+c).trim(); return `<option value="${f}">${f}</option>`}).join(''); }
    }
    document.getElementById('startBtn').addEventListener('click',()=>{
      const educator=document.getElementById('educatorName').value.trim();
      const patient=(document.getElementById('patientSelect').value||'').trim()||'Anonimo';
      const num=parseInt(document.getElementById('numItems').value,10);
      const tts=document.getElementById('ttsFeedback').value==='on';
      if(!educator){ alert('Inserisci il nome dell\'educatore'); return; }
      localStorage.setItem('exerciseConfig', JSON.stringify({educatorName:educator, patientName:patient, numItems:num, ttsFeedback:tts}));
      location.href='index.html?fromSetup=1';
    });
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>


